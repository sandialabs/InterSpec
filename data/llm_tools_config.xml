<?xml version="1.0" encoding="UTF-8"?>
<!--
  This file contains tool definitions that will be loaded into the LLM system.
  All tools defined here will override the default hardcoded definitions in C++.

  To customize tool behavior, copy this file to your OS provided data directory for InterSpec
  (same location as llm_config.xml - see "Help" > "About InterSpec" > "Data" for the actual location).
-->

<LlmConfig version="0">
<ToolDefinitions version="0">

  <!-- Peak Detection and Analysis Tools -->

  <Tool name="get_detected_peaks">
    <Description>Returns all Regions Of Interest (ROI) with peaks detected by automated peak search, or that has been added to the internal analysis peak state. For ROI gives lower and upper energies, and for each peak it gives energy (in keV), FWHM, amplitude (area), statistical significance (numSigma), and if an analysis peak (isAnalysisPeak); if the peak is associated with a source, will also give that information.  Additional peaks may be fittable in data, as the automated peak search algorithm is not perfect.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
          "specType": {
            "type": "string",
            "description": "Which displayed spectrum to search for peaks in; the user is almost always interested in the Foreground, except to check if a peak is in both the foreground and background.",
            "enum": ["Foreground", "Background", "Secondary"]
          },
          "NonBackgroundPeaksOnly": {
            "type": "boolean",
            "description": "Optional: If specified true, only peaks without a cooresponding background spectrum peak, or peaks notably elevated over the background, will be returned. May only be specified true for the 'Foreground' spectrum, and only if a background spectrum is loaded.  If not specified, all peaks for the spectrum are returned."
          }
      },
      "required": ["specType"]
    }</ParametersSchema>
  </Tool>

  <Tool name="get_analysis_peaks">
    <Description>Gets the peaks selected to use for further analysis that have either been manually added by the user, or by the 'add_analysis_peak' tool call, or similar.  These peaks are tracked by an internal state, and are used for things like activity/shielding fitting and tracking nuclides identified.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
          "specType": {
            "type": "string",
            "description": "Optional: Which displayed spectrum to search for peaks in; if not specified will use foreground (which is what user usually wants).",
            "enum": ["Foreground", "Background", "Secondary"]
          },
          "lowerEnergy": {
            "type": "number",
            "description": "Optional: minimum energy (in keV) for peaks to return. If not specified, no lower bound is applied."
          },
          "upperEnergy": {
            "type": "number",
            "description": "Optional: maximum energy (in keV) for peaks to return. If not specified, no upper bound is applied."
          }
      }
    }</ParametersSchema>
  </Tool>

  <Tool name="get_identified_sources">
    <Description>Returns a list of unique sources (nuclides, x-ray elements, or reactions) that are currently assigned to user peaks in the specified spectrum. Each source appears only once in the list, even if multiple peaks are assigned to that source. Also includes user-defined labels that do not contain 'unknown'. This is useful for getting an overview of what sources have been identified in the spectrum.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
          "specType": {
            "type": "string",
            "description": "Optional: Which displayed spectrum to get identified sources from; if not specified will use foreground (which is what user usually wants).",
            "enum": ["Foreground", "Background", "Secondary"]
          }
      }
    }</ParametersSchema>
  </Tool>

  <Tool name="get_unidentified_peaks">
    <Description>Returns the list of foreground peaks (either detected by the auto peak search algorithm or in the internal analysis peak state) that do not have a source (nuclide, x-ray element, or reaction) assigned to them, and that are not consistent with the background spectrum (if present) peaks. Results are sorted by amplitude (largest first) and limited to the specified maximum number of results.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "max_results": {
          "type": "integer",
          "description": "Maximum number of peaks to return, sorted by amplitude (largest first). Defaults to 5 if not specified.",
          "minimum": 1,
          "default": 5
        }
      }
    }</ParametersSchema>
  </Tool>

  <Tool name="add_analysis_peak">
    <Description>Fit and add a peak to the users peaks, at approximately the specified energy, optionally associating a source with it.  Returns Region Of Interest that was either created, or the peak was added to.  If fit failed, reason will be described in 'error' field.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
          "energy": {
            "type": "number",
            "description": "Approximate energy (in keV) to look for a peak to fit."
          },
          "source": {
            "type": "string",
            "description": "Optional: The parent nuclide (ex U235, I131, Ba133) or x-ray flourescense element (ex Pb, U, W) or nuclear reaction (ex H(n,g)) assigned to the peak."
          },
          "specType": {
            "type": "string",
            "description": "Optional: Which displayed spectrum to search for peaks in; if not specified will use foreground (which is what user usually wants).",
            "enum": ["Foreground", "Background", "Secondary"]
          },
          "DoNotAddToAnalysisPeaks": {
            "type": "boolean",
            "description": "Optional: if true, the fit peak will not be added to the users analysis peaks, and instead the fit values will just be returned; defaults to false (i.e., peaks are added by default)."
          }
      },
      "required": ["energy"]
    }</ParametersSchema>
  </Tool>

  <Tool name="edit_analysis_peak">
    <Description>Edit or delete a peak at approximately the specified energy. Can modify peak properties (energy, FWHM, amplitude and their uncertainties), ROI bounds (lower/upper), continuum type (None, Constant, Linear, Quadratic, Cubic, FlatStep, LinearStep, BiLinearStep, External), skew type (NoSkew, Bortel, GaussExp, CrystalBall, ExpGaussExp, DoubleSidedCrystalBall), assign source (nuclide like Ba133, Co60 1332.49 keV, xray like Pb, or reaction like H(n,g)), set peak color (CSS color string), set user label, set flags for energy calibration/shielding/efficiency usage, delete peak, split peak into its own ROI, or merge ROI with adjacent peak.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
          "energy": {
            "type": "number",
            "description": "Energy (in keV) of the peak to edit; will find nearest peak within 1 FWHM."
          },
          "editAction": {
            "type": "string",
            "description": "Action to perform on the peak",
            "enum": ["SetEnergy", "SetFwhm", "SetAmplitude", "SetEnergyUncertainty", "SetFwhmUncertainty", "SetAmplitudeUncertainty", "SetRoiLower", "SetRoiUpper", "SetSkewType", "SetContinuumType", "SetSource", "SetColor", "SetUserLabel", "SetUseForEnergyCalibration", "SetUseForShieldingSourceFit", "SetUseForManualRelEff", "DeletePeak", "SplitFromRoi", "MergeWithLeft", "MergeWithRight"]
          },
          "doubleValue": {
            "type": "number",
            "description": "Numeric value for actions that require a number (SetEnergy, SetFwhm, SetAmplitude, SetRoiLower, SetRoiUpper, and uncertainty variants)"
          },
          "stringValue": {
            "type": "string",
            "description": "String value for SetSource (e.g., Ba133, Co60 1332.49 keV), SetColor (CSS color), SetUserLabel (text note), SetSkewType (NoSkew/Bortel/GaussExp/CrystalBall/ExpGaussExp/DoubleSidedCrystalBall), or SetContinuumType (None/Constant/Linear/Quadratic/Cubic/FlatStep/LinearStep/BiLinearStep/External)"
          },
          "boolValue": {
            "type": "boolean",
            "description": "Boolean value for SetUseForEnergyCalibration, SetUseForShieldingSourceFit, or SetUseForManualRelEff actions"
          },
          "specType": {
            "type": "string",
            "enum": ["Foreground", "Background", "Secondary"],
            "description": "Optional: Which spectrum the peak is in (default: Foreground)"
          }
      },
      "required": ["energy", "editAction"]
    }</ParametersSchema>
  </Tool>

  <Tool name="escape_peak_check">
    <Description>Check if a peak at a specified energy is a single or double escape peak of another peak in the spectrum. Returns the parent peak information if found, plus calculated energies where potential escape peaks or parent peaks could exist.  If the parent peak is found, and it has an assigned source, a "sourceLabel" will be returned that can be used to set the peaks source, or if the parent peak does not have a source, a "userLabel" will be returned that should be used to set the peaks user-label.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
          "energy": {
            "type": "number",
            "description": "Energy (in keV) of the peak to check for being an escape peak, or to calculate potential escape peak energies for."
          },
          "specType": {
            "type": "string",
            "enum": ["Foreground", "Background", "Secondary"],
            "description": "Optional: Which displayed spectrum to check (default: Foreground)."
          }
      },
      "required": ["energy"]
    }</ParametersSchema>
  </Tool>

  <Tool name="sum_peak_check">
    <Description>Check if a peak at a specified energy is a sum peak, where two lower-energy photons are detected simultaneously and their energies add together. There are two types: (1) Cascade-sum peaks occur when a nuclide emits two photons nearly simultaneously during decay and the detector is close enough to detect both (typically &lt;15 cm). Both contributing peaks must have the same nuclide source assigned. (2) Random-sum peaks (pile-up) occur when unrelated photons arrive simultaneously, typically when dead time is high (&gt;20% for HPGe, &gt;10% for low-resolution detectors). The function returns the sum type (CascadeSum, RandomSum, Unknown, or NotASumPeak), information about the two contributing peaks (energy, area, source), and appropriate labels (sourceLabel or userLabel) that can be used to identify the peak. When multiple candidate peak pairs are found, the best match is selected based on closest energy match, or if energies are similar, the pair with largest combined areas. An optional distance parameter can be provided to disable cascade-sum detection if the source is far from the detector (&gt;15 cm).</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
          "energy": {
            "type": "number",
            "description": "Energy (in keV) of the peak to check for being a sum peak."
          },
          "specType": {
            "type": "string",
            "enum": ["Foreground", "Background", "Secondary"],
            "description": "Optional: Which displayed spectrum to check (default: Foreground)."
          },
          "distance": {
            "type": "string",
            "description": "Optional: Source-to-detector distance (e.g., '10 cm', '1 m', '50 mm'). If greater than 15 cm, cascade-sum detection is disabled and only random-sum peaks are considered. If not specified, both types are checked."
          }
      },
      "required": ["energy"]
    }</ParametersSchema>
  </Tool>

<!--
  <Tool name="add_analysis_peaks_for_source">
    <Description>Fits peaks for the one or more specified nuclide(s). Returns the peaks that were fit.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "nuclide": {
          "anyOf": [
            {"type": "string"},
            {"type": "array", "items": {"type": "string"}}
          ],
          "description": "The nuclide or array of nuclides to fit peaks for (ex U235, I131, Ba133)."
        },
        "doNotAddPeaksToUserSession": {
          "type": "boolean",
          "description": "Optional: if true, fitted peaks will not be added to the user's peak collection; defaults to false."
        }
      },
      "required": ["nuclide"]
    }</ParametersSchema>
  </Tool>
 -->

  <!-- Spectrum Information Tools -->

  <Tool name="get_spectrum_info">
    <Description>Get basic information about the currently loaded spectrum</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
          "specType": {
            "type": "string",
            "description": "Which spectrum to get info for",
            "enum": ["Foreground", "Background", "Secondary"]
          }
      },
      "required": ["specType"]
    }</ParametersSchema>
  </Tool>

  <Tool name="loaded_spectra">
    <Description>Returns array of the currently loaded spectra from ["Foreground", "Background", "Secondary"].  If no spectra are loaded, returns empty array.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
      }
    }</ParametersSchema>
  </Tool>

  <Tool name="get_counts_in_energy_range">
    <Description>Get the photon counts in the spectra for the specified energy range, as well as compares statistical significance of differences between foreground and background and/or secondary count-rates, if those spectra are loaded.  This function can be used to check if the count rate of an energy range is elevated in the foreground relative to the background, especially above the 2614 keV peak.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "lowerEnergy": {
          "type": "number",
          "description": "The lower energy bound in keV."
        },
        "upperEnergy": {
          "type": "number",
          "description": "The upper energy bound in keV."
        }
      },
      "required": ["lowerEnergy", "upperEnergy"]
    }</ParametersSchema>
  </Tool>

  <Tool name="get_expected_fwhm">
    <Description>Calculate the expected Full Width at Half Maximum (FWHM) for a peak at the specified energy, based on the detector response function, detected peaks, or detector type. This is useful for determining the expected width of a peak for ROI calculations.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "energy": {
          "type": "number",
          "description": "The energy (in keV) to calculate the expected FWHM for."
        }
      },
      "required": ["energy"]
    }</ParametersSchema>
  </Tool>

  <Tool name="automated_source_id_results">
    <Description>Get the source (isotope, flourescent x-ray, or nuclear reaction) ID from the avaiable automated ID algorithms. Will return the detection systems on-board nuclide ID results, if present, as well as the GADRAS Full Spectrum Isotope ID results if the app is configured to get.  These automated results can be wrong or incomplete, so should used at most as a starting point, or something to check.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
      }
    }</ParametersSchema>
  </Tool>

  <!-- Nuclear Data Tools -->

  <Tool name="primary_gammas_for_source">
    <Description>Get the most likely energies a peak will be detected at for a source (nuclide, flourescent x-ray, or nuclear reaction). Returns one to a few energies (in keV).  This is only a rough guess at the most prominent or unique peaks for the source; not detecting a peak at these energies does not rule out a source, but it makes the source a candidate.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "source": {
          "type": "string",
          "description": "The source (nuclide, x-ray element, or nuclear reaction) to get the characteristic gammas for."
        }
      },
      "required": ["source"]
    }</ParametersSchema>
  </Tool>

  <Tool name="sources_with_primary_gammas_in_energy_range">
    <Description>Get the commonly encountered field nuclides, x-ray elements, or reactions with primary gammas in the specified energy range.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "lowerEnergy": {
          "type": "number",
          "description": "The lower energy (in keV) to search for primary gammas."
        },
        "upperEnergy": {
          "type": "number",
          "description": "The upper energy (in keV) to search for primary gammas."
        }
      },
      "required": ["lowerEnergy", "upperEnergy"]
    }</ParametersSchema>
  </Tool>

  <Tool name="sources_with_primary_gammas_near_energy">
    <Description>Get the commonly encountered field nuclides, x-ray elements, or reactions with primary gammas near the specified energy.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "energy": {
          "type": "number",
          "description": "The energy (in keV) to search for primary gammas."
        }
      },
      "required": ["energy"]
    }</ParametersSchema>
  </Tool>
<!--
  <Tool name="sources_associated_with_source">
    <Description>Gets other sources (nuclides, reactions, x-rays) that are commonly detected along with the specified source, or sources that might be mis-identified as the specified source.  You you should check for these associated sources being present or not when the specified source is observed.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "source": {
          "type": "string",
          "description": "The source to get associated sources for."
        }
      },
      "required": ["source"]
    }</ParametersSchema>
  </Tool>

  <Tool name="analyst_notes_for_source">
    <Description>Gets analyst notes for the specified source (nuclide, x-ray, reaction), such as when the source is used/seen, typical activity ranges of nuclides, etc.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "source": {
          "type": "string",
          "description": "The source to get analyst notes for."
        }
      },
      "required": ["source"]
    }</ParametersSchema>
  </Tool>
-->

  <Tool name="source_info">
    <Description>Gets relevant information about the specified source (nuclide, x-ray element, reaction), such as half-life, decay modes, analyst notes (such as when the source is used/seen, typical activity ranges of nuclides, etc.), associated sources (i.e. sources that are commonly detected along with the specified source, or sources that might be mis-identified as the specified source - you should check for these associated sources being present or not when the specified source is observed), source catagories (medical, NORM, industrial, etc), and other nuclear data.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "source": {
          "type": "string",
          "description": "The source to get data for."
        }
      },
      "required": ["source"]
    }</ParametersSchema>
  </Tool>

  <Tool name="nuclide_decay_chain">
    <Description>Returns a list of all progeny nuclides, of the specified nuclide, and thier decay modes and branching ratios.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "nuclide": {
          "type": "string",
          "description": "The nuclide to get data for."
        }
      },
      "required": ["nuclide"]
    }</ParametersSchema>
  </Tool>

  <!-- TODO: consider adding escape peak option to "source_photons" -->
  <Tool name="source_photons">
    <Description>Returns a list of energy/intensity pairs associated with a nuclide, elemental fluorescence x-rays, or reaction.  The energies are expressed in keV, and intensities are given as photons per source Becquerel for nuclides, or normalized to 1 for flourescence or reactions.  Results will be sorted by energy.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "Source": {
          "type": "string",
          "description": "The nuclide, element, or reaction for which to retrieve decay product data. Examples: 'U238' (nuclide), 'Pb' (element), 'H(n,g)' (reaction)."
        },
        "Age": {
          "type": "string",
          "description":  "The age of the nuclide at which to return decay products. Applicable only for nuclides; specifying this for elements or reactions will result in an error. If not specified for nuclides, a default age will be used. Examples: '23.25 y', '23 years 60 days', '0s', '5 half-lives'. An age of '0 seconds' will return products from the specified nuclide only, while a positive value will include products from the nuclide's full decay chain, aged to the specified amount."
        },
        "MaxResults": {
          "type": "integer",
          "minimum": 1,
          "description": "The maximum number of energy/intensity pairs to return; if the source has more than this number of photons, then information for this number of the largest intensity photons will be returned.  If not specified, a value of 125 will be assumed."
        },
        "IncludeCascadeSumEnergies": {
          "type": "boolean",
          "description": "Optional: default false. If true, results will also include a list of top gamma pairs that may sum (gammas emitted at the same time that may be detected together), and is only relevant for nuclide sources and measurements less than ~15 cm from the source. The 'MaxResults' argument also limits the max possible length of these results."
        }
      },
      "required": ["Source"]
    }</ParametersSchema>
  </Tool>

  <!-- Search and Identification Tools -->

  <Tool name="search_sources_by_energy">
    <Description>Searches for radiation sources (nuclides, x-rays, reactions) that have gammas, x-rays, alphas, and/or beta-end-point at specified energies. Returns candidate sources ranked by how well they match the input energies and current foreground spectrum.

It is best to only search on a single energy at a time, and only for foreground peaks whose source is not identified; do not search on multiple energies unless you are investigating or suspect they are from the same source, or are really having a hard time identifying a source.

The 'profile_score' metric (larger = better match) is the best indicator of fit quality for the loaded spectrum, considering peak heights and detector response.

Further investigation of top returned candidates is required to make sure they match the spectrum (e.g., the spectrum is not missing a peak it should have from that source, or the peaks in the spectrum have expected relative amplitudes, etc.)</Description>
<Description role="NuclideId">Your primary identification tool. Search for candidate nuclides by gamma energy. Use extensively with single-energy searches. The profile_score metric (higher=better) accounts for peak heights and detector response. Prefer single-energy searches - only use 2-3 energies if desperately needed.</Description>
<AvailableFor><Agent>MainAgent</Agent><Agent>NuclideId</Agent><Agent>NuclideIdWorker</Agent></AvailableFor>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "energies": {
          "type": "array",
          "description": "The energies the source MUST match.  Since the source must match ALL entries, it is best to only search on one to a few unidentified peaks at a time, ususally starting with only a single peak, and then moving to two only if no satisfactory answer can be found. You usually will not want to search on a foreground peak that roughly aligns in energy with a background peak (either auto-search peak, or user/analysis fit peak), unless the foreground peak CPS is substantially elevated relative to the background peak.",
          "items": {
            "type": "object",
            "properties": {
              "energy": {
                "type": "number",
                "description": "Energy in keV to search for"
              },
              "window": {
                "type": "number",
                "description": "Search window (±keV) around this energy. If not specified, defaults to the recomended window of 1.27 times the expected FWHM at that energy, or if expected FWHM cant be determined, 1.5 keV for HPGe detectors or 10 keV for other detector types.  If the expected FWHM is not known, then it is recomended to not specify this field."
              }
            },
            "required": ["energy"]
          },
          "minItems": 1,
          "description": "Array of energies to search for. Each source must have emissions matching ALL specified energies."
        },
        "source_category": {
          "type": "string",
          "enum": ["Nuclides + X-rays", "Nuclides, X-rays, Reactions", "Fluorescence x-rays", "Reactions", "Medical Nuclides", "Industrial Nuclides", "SNM", "NORM", "Field Encountered Sources", "Field Encountered Nuclides", "Nuclear Reactions", "Fission Products", "Alphas", "Beta Endpoint", "Un-aged Nuclides"],
          "description": "Category filter for source types to search. Default is 'Nuclides + X-rays'."
        },
        "min_half_life": {
          "type": "string",
          "description": "Minimum nuclide half-life as a string (e.g., '10 s', '5 min', '1 h', '2 y'). Default is '100 m'."
        },
        "min_branching_ratio": {
          "type": "number",
          "description": "Minimum relative branching ratio (0.0 to 1.0). This is the aged gamma line BR divided by max intensity line. Default is 0.0."
        },
        "max_results": {
          "type": "integer",
          "description": "Maximum number of results to return. Default is 10."
        },
        "sort_by": {
          "type": "string",
          "enum": ["ProfileScore", "SumEnergyDifference"],
          "description": "Sort criterion: 'ProfileScore' (larger=better, considers spectrum fit and peak heights) or 'SumEnergyDifference' (smaller=better, simple energy distance). Default is 'ProfileScore'."
        }
      },
      "required": ["energies"]
    }</ParametersSchema>
  </Tool>

  <!-- Detection Limit and Efficiency Tools -->

  <Tool name="currie_mda_calc">
    <Description>Calculate Minimum Detectable Activity (MDA) and detection confidence intervals using Currie-style (ISO 11929) methodology. Determines if a peak is detectable at a specified energy. Returns decision threshold, detection limit, and confidence intervals - as well as if it looks like a peak is at the energy (see `peakPresentInData` in output).</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "energy": {
          "type": "number",
          "description": "The energy (in keV) of the photopeak for which the detection limit is being calculated."
        },
        "detectionProbability": {
          "type": "number",
          "description": "Optional: Detection probability (confidence level), typically 0.95 for 95% confidence. Defaults to 0.95.",
          "minimum": 0.5,
          "maximum": 0.999,
          "default": 0.95
        },
        "additionalUncertainty": {
          "type": "number",
          "description": "Optional: Additional relative uncertainty to include (e.g., from detector response function uncertainties). Defaults to 0.0.",
          "minimum": 0.0,
          "default": 0.0
        }
      },
      "required": ["energy"]
    }</ParametersSchema>
  </Tool>

  <Tool name="photopeak_detection_efficiency">
    <Description>Given an array of source photon energies, returns the fraction of photons that will contribute to a peak in data. The returned answer will include the attenuation factor of shielding (if specified), the fraction of photons making it to the detector (if distance is specified), the detection probability of photons that are incident upon the detector (i.e., the intrinsic detection efficiency) if a detector efficiency function is loaded (use 'detector_efficiency_function_info' tool call with no arguments to see if a detector efficiency function is loaded, and 'available_detector_efficiency_functions' and 'load_detector_efficiency_function' to load an efficiency function), and gives total detection probability.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "Energies": {
          "type": "array",
          "items": {"type": "number"},
          "description": "Array of photon energies in keV"
        },
        "Distance": {
          "type": "string",
          "description": "Optional: Distance from source to detector face (e.g., '10 cm', '1 m')"
        },
        "Shielding": {
          "type": "array",
          "items": {
            "type": "object",
            "description": "Optional: Defines the shielding used to attenuate gammas and x-rays. Shielding must be specified in one of two formats.",
            "oneOf": [{
              "type": "object",
              "properties": {
                "AD": {
                  "type": "number",
                  "description": "Areal density of the shielding material in g/cm²."
                },
                "AN": {
                  "type": "number",
                  "description": "Effective atomic number of the shielding material."
                }
              },
              "required": ["AD", "AN"],
              "additionalProperties": false
            },{
              "type": "object",
              "properties": {
                "Material": {
                  "type": "string",
                  "description": "The shielding material, specified as an element symbol or material name. Available material names are returned by the `get_materials` tool. Example: 'Fe', which is equivalent to 'Iron', or 'glass_plate', which is returned from `get_materials`."
                },
                "Thickness": {
                  "type": "string",
                  "description": "The thickness of the shielding material, specified as a string with units. Example: '1.25cm'."
                }
              },
              "required": ["Material", "Thickness"],
              "additionalProperties": false
            }]
          },
          "description": "An array of shielding objects, applied in order from source to detector. Each shielding layer attenuates the photons that pass through it."
        }
      },
      "required": ["Energies"]
    }</ParametersSchema>
  </Tool>

  <!-- Detector Efficiency Tools -->

  <Tool name="available_detector_efficiency_functions">
    <Description>Returns a list of detector efficiency function names that can be loaded to the foreground spectrum.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {},
      "required": []
    }</ParametersSchema>
  </Tool>

  <Tool name="load_detector_efficiency_function">
    <Description>Loads a detector efficiency function to use for calculations. Can load from default available detectors, user previously used, filesystem path, GADRAS directory, or URI.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "identifier": {
          "type": "string",
          "description": "The detector efficiency function identifier. Can be a name from available_detector_efficiency_functions, a filesystem path to a detector file or GADRAS directory, or a URI. Required."
        },
        "detectorName": {
          "type": "string",
          "description": "Optional: The specific detector name to use when the identifier points to a file containing multiple detector efficiencies (e.g., RelEff CSV files). If not specified and the file contains only one detector, that detector will be used. If not specified and the file contains multiple detectors, an error will be returned."
        },
        "source": {
          "type": "string",
          "enum": ["DefaultAvailable", "UserPreviouslyUsed", "FilePath", "GadrasDirectory", "URI", "AnySource"],
          "description": "Optional: Source type hint for loading. DefaultAvailable: built-in detectors. UserPreviouslyUsed: user's database. FilePath: filesystem path to detector file. GadrasDirectory: GADRAS detector directory. URI: web URI. AnySource: try all options in order. Defaults to AnySource if not specified."
        }
      },
      "required": ["identifier"]
    }</ParametersSchema>
  </Tool>

  <Tool name="detector_efficiency_function_info">
    <Description>Returns information (name, description, if has FWHM info, or if is fixed geometry, etc) about either the currently loaded detector efficiency function, or if a name is specified, that detectors efficiency function.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Optional: The name of the detector efficiency function to return information about. If not specified, will return information about the currently loaded detector efficiency function."
          }
      },
      "required": []
    }</ParametersSchema>
  </Tool>

  <!-- Shielding and Material Tools -->

  <Tool name="get_materials">
    <Description>Returns a list of avaiable materials for shielding. The materials name is what you will specify to other functions to use it as a shielding.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {},
      "additionalProperties": false
    }</ParametersSchema>
  </Tool>

  <Tool name="get_material_info">
    <Description>Returns shielding material information (density, effective atomic number, elemental mass fractions, etc).</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "material": {
          "type": "string",
          "description": "The shielding material name to get information about."
          }
      },
      "required": ["material"]
    }</ParametersSchema>
  </Tool>

  <!-- Activity/Shielding Fit Tools (ActivityFit Agent Only) -->

  <Tool name="activity_fit">
    <Description>Perform activity and shielding fitting using gamma ray peaks. Supports three modes: (1) from_app_state - uses existing GUI state or saved model, shows GUI; (2) single_peak - fits activity for one peak/nuclide; (3) custom - full control over sources, shielding, geometry. Can fit nuclide ages when progeny peaks are present. Returns fitted activities, shielding parameters, fit quality metrics, and per-peak observed vs expected counts with source contributions.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "mode": {
          "type": "string",
          "enum": ["from_app_state", "single_peak", "custom"],
          "description": "Fitting mode: from_app_state uses existing configuration and shows GUI; single_peak fits one peak; custom allows full specification"
        },
        "peak_energies": {
          "type": "array",
          "items": {"type": "number"},
          "description": "Peak energies in keV to use for fitting. Tolerance is max(peak FWHM, 1 keV). Required for single_peak and custom modes. Optional for from_app_state to filter peaks. Peaks must already be assigned to nuclides."
        },
        "distance": {
          "type": "string",
          "description": "Source-to-detector distance with units (e.g., '100 cm', '3 ft', '1.5 m'). If numeric value provided, assumes cm. Required for non-fixed-geometry detectors. For from_app_state mode, overrides existing distance if specified."
        },
        "geometry": {
          "type": "string",
          "enum": ["Spherical", "CylinderSideOn", "CylinderEndOn", "Rectangular"],
          "description": "Shielding geometry type. All shielding layers share this geometry. Default: Spherical for point sources."
        },
        "shielding": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "material": {
                "type": "string",
                "description": "Material name (e.g., 'Fe', 'Pb', 'Steel') or chemical formula (e.g., 'H2O')"
              },
              "radial_thickness": {
                "type": "string",
                "description": "Thickness with units for Spherical geometry (e.g., '0.5 cm', '2 mm'). If omitted, thickness will be fit. If specified, thickness is fixed unless fit_thickness is true."
              },
              "fit_thickness": {
                "type": "boolean",
                "description": "Whether to fit thickness as a parameter. Default: true if radial_thickness not specified, false otherwise."
              },
              "radius": {
                "type": "string",
                "description": "For CylinderSideOn or CylinderEndOn geometry: cylinder radius with units (e.g., '2.5 cm')"
              },
              "fit_radius": {
                "type": "boolean",
                "description": "Whether to fit cylinder radius"
              },
              "length": {
                "type": "string",
                "description": "For CylinderSideOn or CylinderEndOn geometry: cylinder length with units"
              },
              "fit_length": {
                "type": "boolean",
                "description": "Whether to fit cylinder length"
              },
              "width": {
                "type": "string",
                "description": "For Rectangular geometry: width dimension with units"
              },
              "fit_width": {
                "type": "boolean",
                "description": "Whether to fit width"
              },
              "height": {
                "type": "string",
                "description": "For Rectangular geometry: height dimension with units"
              },
              "fit_height": {
                "type": "boolean",
                "description": "Whether to fit height"
              },
              "depth": {
                "type": "string",
                "description": "For Rectangular geometry: depth dimension with units"
              },
              "fit_depth": {
                "type": "boolean",
                "description": "Whether to fit depth"
              },
              "trace_sources": {
                "type": "array",
                "description": "Optional: trace sources contaminating this shielding layer",
                "items": {
                  "type": "object",
                  "properties": {
                    "nuclide": {
                      "type": "string",
                      "description": "Nuclide symbol (e.g., 'Cs137', 'Co60')"
                    },
                    "activity_type": {
                      "type": "string",
                      "enum": ["per_cm3", "total_activity", "per_gram", "exponential"],
                      "description": "Type of trace source distribution. Default: per_cm3. Units: per_cm3 uses Ci/cm3 or Bq/cm3, total_activity uses Ci or Bq, per_gram uses Ci/g or Bq/g, exponential uses Ci/m2 or Bq/m2"
                    },
                    "activity": {
                      "type": "string",
                      "description": "Initial activity guess with units (e.g., '1 uCi/cm3', '10 kBq', '0.5 mCi/g'). Can use metric prefixes (u, m, k, M, G) with Ci or Bq."
                    },
                    "fit_activity": {
                      "type": "boolean",
                      "description": "Whether to fit the trace source activity. Default: true"
                    },
                    "relaxation_distance": {
                      "type": "string",
                      "description": "For exponential distribution only: characteristic length with units (e.g., '5 cm'). Not fittable."
                    }
                  },
                  "required": ["nuclide", "activity"]
                }
              }
            },
            "required": ["material"]
          },
          "description": "Array of shielding layers from innermost to outermost. All layers use the same geometry."
        },
        "sources": {
          "type": "array",
          "description": "For custom mode: explicit source definitions. For other modes, derived from peak assignments.",
          "items": {
            "type": "object",
            "properties": {
              "nuclide": {
                "type": "string",
                "description": "Nuclide symbol (e.g., 'U238', 'Co60', 'Cs137')"
              },
              "fit_activity": {
                "type": "boolean",
                "description": "Whether to fit activity. Default: true for Point sources, false for Intrinsic (activity derived from shielding dimensions)"
              },
              "activity": {
                "type": "string",
                "description": "Initial activity guess with units (e.g., '10 uCi', '1 MBq'). Required for Point sources."
              },
              "fit_age": {
                "type": "boolean",
                "description": "Whether to fit nuclide age. Only allowed if: (1) nuclide has >= 2 unique progeny peaks assigned to it, or (2) this source is a dependent via age_defining_nuclide. Age fitting not allowed for nuclides reaching equilibrium quickly (e.g., Cs137). Default: false (opt-in only)"
              },
              "age": {
                "type": "string",
                "description": "Nuclide age with units (e.g., '20 years', '6 months', '100 days'). If numeric, assumes seconds."
              },
              "age_defining_nuclide": {
                "type": "string",
                "description": "For same_age_isotopes mode: symbol of the nuclide whose age this source shares. Isotopes of the same element (e.g., U235 and U238) typically have the same age. If specified, this source's age is controlled by the defining nuclide."
              },
              "source_type": {
                "type": "string",
                "enum": ["Point", "Trace", "Intrinsic"],
                "description": "Source type: Point = point source at center, Trace = trace contamination in shielding (specify via shielding.trace_sources), Intrinsic = self-attenuating source (nuclide is part of shielding material). Default: Point"
              }
            },
            "required": ["nuclide"]
          }
        },
        "options": {
          "type": "object",
          "description": "Optional fitting options",
          "properties": {
            "multiple_nucs_contribute_to_peaks": {
              "type": "boolean",
              "description": "Allow multiple nuclides to contribute to same peak. Default: true"
            },
            "attenuate_for_air": {
              "type": "boolean",
              "description": "Include air attenuation in model. Default: true"
            },
            "account_for_decay_during_meas": {
              "type": "boolean",
              "description": "Account for decay during measurement time. Default: false"
            },
            "photopeak_cluster_sigma": {
              "type": "number",
              "description": "Cluster nearby photopeaks within this many sigma. Default: 1.25"
            },
            "background_peak_subtract": {
              "type": "boolean",
              "description": "Subtract background peak contributions. Default: true"
            },
            "same_age_isotopes": {
              "type": "boolean",
              "description": "Isotopes of the same element share age (e.g., U235 and U238). Default: true"
            }
          }
        }
      },
      "required": ["mode"]
    }</ParametersSchema>
    <AvailableFor>
      <Agent>ActivityFit</Agent>
    </AvailableFor>
  </Tool>

  <Tool name="get_shielding_source_config">
    <Description>Retrieve the current activity/shielding fit configuration from the application state. Returns distance, geometry, source definitions (with ages), shielding layers (with trace sources), and which peaks are marked for use in fitting. Checks InterSpec::shieldingSourceFit() GUI first, then falls back to SpecMeas::m_shieldingSourceModel saved state.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {},
      "additionalProperties": false
    }</ParametersSchema>
    <AvailableFor>
      <Agent>ActivityFit</Agent>
    </AvailableFor>
  </Tool>

  <Tool name="modify_shielding_source_config">
    <Description>Modify the activity/shielding fit configuration in the application state. Can add/remove shielding layers, add/remove sources, set distance, set geometry, set source ages, or set fitting options. Changes are saved to SpecMeas::m_shieldingSourceModel and updated in GUI if open. If dimension is specified when adding shielding (e.g., '0.5 inches'), it's fixed; if omitted, it will be fit.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "operation": {
          "type": "string",
          "enum": ["add_shielding", "remove_shielding", "add_source", "remove_source", "set_distance", "set_geometry", "set_source_age", "set_fit_options"],
          "description": "Operation to perform on the configuration"
        },
        "material": {
          "type": "string",
          "description": "For add_shielding: material name or formula. For remove_shielding: material name to remove (use either this or index)."
        },
        "index": {
          "type": "integer",
          "description": "For remove_shielding: zero-based index of shielding layer to remove (use either this or material)."
        },
        "radial_thickness": {
          "type": "string",
          "description": "For add_shielding with Spherical geometry: thickness with units. If specified, thickness is fixed; if omitted, will be fit."
        },
        "fit_thickness": {
          "type": "boolean",
          "description": "For add_shielding: explicit control over whether to fit thickness"
        },
        "radius": {
          "type": "string",
          "description": "For add_shielding with Cylinder geometry: radius with units"
        },
        "fit_radius": {
          "type": "boolean",
          "description": "For add_shielding: whether to fit cylinder radius"
        },
        "length": {
          "type": "string",
          "description": "For add_shielding with Cylinder geometry: length with units"
        },
        "fit_length": {
          "type": "boolean",
          "description": "For add_shielding: whether to fit cylinder length"
        },
        "geometry": {
          "type": "string",
          "enum": ["Spherical", "CylinderSideOn", "CylinderEndOn", "Rectangular"],
          "description": "For set_geometry: new geometry type. For add_shielding: geometry for the layer."
        },
        "distance": {
          "type": "string",
          "description": "For set_distance: new source-to-detector distance with units (e.g., '100 cm', '3 ft')"
        },
        "nuclide": {
          "type": "string",
          "description": "For add_source/remove_source/set_source_age: nuclide symbol"
        },
        "activity": {
          "type": "string",
          "description": "For add_source: initial activity with units (e.g., '10 uCi')"
        },
        "age": {
          "type": "string",
          "description": "For add_source or set_source_age: nuclide age with units (e.g., '20 years')"
        },
        "fit_age": {
          "type": "boolean",
          "description": "For add_source: whether to fit the age"
        },
        "source_type": {
          "type": "string",
          "enum": ["Point", "Trace", "Intrinsic"],
          "description": "For add_source: source type. Default: Point"
        },
        "attenuate_for_air": {
          "type": "boolean",
          "description": "For set_fit_options: whether to include air attenuation in the model. Default: true"
        },
        "multiple_nucs_contribute_to_peaks": {
          "type": "boolean",
          "description": "For set_fit_options: allow multiple nuclides to contribute to the same peak. Default: true"
        },
        "background_peak_subtract": {
          "type": "boolean",
          "description": "For set_fit_options: whether to subtract background peak contributions. Default: true"
        },
        "same_age_isotopes": {
          "type": "boolean",
          "description": "For set_fit_options: isotopes of the same element share the same age (e.g., U235 and U238). Default: true"
        }
      },
      "required": ["operation"]
    }</ParametersSchema>
    <AvailableFor>
      <Agent>ActivityFit</Agent>
    </AvailableFor>
  </Tool>

  <Tool name="mark_peaks_for_activity_fit">
    <Description>Mark peaks to be used (or not used) in activity/shielding fitting. Updates the PeakDef::useForShieldingSourceFit() flag for specified peaks. Peaks are matched by energy with tolerance of max(peak FWHM, 1 keV).</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "peak_energies": {
          "type": "array",
          "items": {"type": "number"},
          "description": "Array of peak energies in keV to mark/unmark"
        },
        "use_for_fit": {
          "type": "boolean",
          "description": "Whether to use these peaks for fitting (true) or exclude them (false)"
        },
        "specType": {
          "type": "string",
          "enum": ["Foreground", "Background", "Secondary"],
          "description": "Optional: Which spectrum to operate on. Default: Foreground"
        }
      },
      "required": ["peak_energies", "use_for_fit"]
    }</ParametersSchema>
    <AvailableFor>
      <Agent>ActivityFit</Agent>
    </AvailableFor>
  </Tool>

  <Tool name="close_activity_shielding_display">
    <Description>Close the Activity/Shielding fit GUI window (ShieldingSourceDisplay) if it is open. Does not affect the saved configuration state.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {},
      "additionalProperties": false
    }</ParametersSchema>
    <AvailableFor>
      <Agent>ActivityFit</Agent>
    </AvailableFor>
  </Tool>

  <Tool name="ask_user_question">
    <Description>Ask the user a question via a modal dialog box and wait for their text response. Use sparingly - only when critical information is ambiguous and cannot be reasonably inferred. The dialog blocks other user interactions until answered. Prefer making reasonable assumptions based on context over asking questions.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "question": {
          "type": "string",
          "description": "The question to ask the user. Should be clear, concise, and explain why the information is needed."
        },
        "default_response": {
          "type": "string",
          "description": "Optional: pre-filled text in the response field to guide the user or suggest a default answer"
        }
      },
      "required": ["question"]
    }</ParametersSchema>
    <AvailableFor>
      <Agent>ActivityFit</Agent>
    </AvailableFor>
  </Tool>

  <Tool name="set_workflow_state">
    <Description>Set the current workflow state for agents that use state machines. This tool is used by agents to track their progress through multi-step workflows and receive state-specific guidance. State machines are completely optional - agents without them can ignore this tool. The state machine provides soft enforcement: warnings are issued for unexpected transitions but the state change is still allowed. Each state has guidance text that helps the agent understand what to do next and which tools are typically needed in that state.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "state": {
          "type": "string",
          "description": "The name of the state to transition to. Valid state names are defined in the agent's state machine configuration in llm_agents.xml. Common states for isotopics workflows include: ANALYZE_REQUEST (understand user needs), SELECT_CONFIGURATION (choose appropriate preset), VALIDATE_CONFIGURATION (verify setup is correct), CHECK_INTERFERENCE (look for problematic peaks), EXECUTE_CALCULATION (run the analysis), EVALUATE_RESULTS (assess quality), FINALIZE_RESULTS (present to user)."
        },
        "notes": {
          "type": "string",
          "description": "Optional notes about why this state transition is being made or what was accomplished in the previous state. Helps with debugging and understanding the agent's reasoning."
        }
      },
      "required": ["state"]
    }</ParametersSchema>
    <AvailableFor>
      <Agent>Isotopics</Agent>
    </AvailableFor>
  </Tool>

  <Tool name="list_isotopics_presets">
    <Description>List available isotopics analysis preset configurations. Returns a list of preset files that can be loaded using load_isotopics_preset. Each preset contains pre-configured settings for specific analysis types like Plutonium isotopics, Uranium enrichment, etc. The list includes a special 'Current Configuration' entry if any configuration is currently loaded. Presets define which nuclides to fit, which energy regions (ROIs) to analyze, detector resolution settings, and other analysis parameters. Some internal/debug presets containing keywords like 'U inside U' or 'multiple U' are filtered out.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {}
    }</ParametersSchema>
    <AvailableFor>
      <Agent>Isotopics</Agent>
    </AvailableFor>
  </Tool>

  <Tool name="get_isotopics_config">
    <Description>Retrieve the current isotopics analysis configuration. Returns detailed information about what is currently configured, including: which energy regions (ROIs) are defined for analysis, which nuclides will be fit in each relative efficiency curve, whether energy calibration will be fit, and the detector resolution model (FWHM form). This allows the agent to verify the configuration is appropriate before running an analysis. Returns null if no configuration is loaded (use load_isotopics_preset first in that case).</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {}
    }</ParametersSchema>
    <AvailableFor>
      <Agent>Isotopics</Agent>
    </AvailableFor>
  </Tool>

  <Tool name="reset_isotopics_config">
    <Description>Clear the current isotopics analysis configuration. This removes any loaded preset configuration and returns to a blank state. Use this when starting a fresh analysis or when the user wants to switch to a completely different analysis type. After resetting, you'll need to load a new preset using load_isotopics_preset before performing any analysis.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {}
    }</ParametersSchema>
    <AvailableFor>
      <Agent>Isotopics</Agent>
    </AvailableFor>
  </Tool>

  <Tool name="load_isotopics_preset">
    <Description>Load an isotopics analysis preset configuration from a file. The preset must be specified either as a filename (e.g., 'PlutoniumIsotopics.xml') or a full path. If only a filename is provided, it will be searched for in the data/rel_act directory and its subdirectories. The preset file contains all the analysis configuration including which nuclides to fit, which energy ROIs to use, detector resolution settings, whether to fit energy calibration, and other options. After loading, the configuration is stored with the foreground spectrum and can be retrieved with get_isotopics_config. Returns a summary of the loaded configuration including ROI count, nuclide list, and key analysis options.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {
        "preset": {
          "type": "string",
          "description": "The preset name or path to load. Can be: (1) a filename like 'PlutoniumIsotopics.xml' which will be found in data/rel_act recursively, (2) a filename without .xml extension (the extension will be added automatically), or (3) a full absolute path to a preset file. Use list_isotopics_presets to discover available presets."
        }
      },
      "required": ["preset"]
    }</ParametersSchema>
    <AvailableFor>
      <Agent>Isotopics</Agent>
    </AvailableFor>
  </Tool>

  <Tool name="perform_isotopics_calculation">
    <Description>Execute isotopics analysis on the currently loaded spectrum using the configuration that was previously loaded via load_isotopics_preset. This performs the actual calculation to determine the mass fractions of isotopes from gamma-ray peak areas, detector response, and nuclear decay data. Before calling this tool, you MUST have: (1) a foreground spectrum loaded, (2) peaks fit to the spectrum, (3) an isotopics configuration loaded via load_isotopics_preset. The tool returns: mass fractions with uncertainties for each isotope, relative activities, ages (time since purification) if fit, quality metrics (chi-squared per degree of freedom), and optionally Pu242-corrected values for Plutonium analysis. Lower chi2/DOF (ideally near 1.0) indicates better fit quality. Values much greater than 2-3 may indicate problems with peak fits, interference, or incorrect configuration.</Description>
    <ParametersSchema>{
      "type": "object",
      "properties": {}
    }</ParametersSchema>
    <AvailableFor>
      <Agent>Isotopics</Agent>
    </AvailableFor>
  </Tool>

</ToolDefinitions>
</LlmConfig>
