find_package(Git)
include(FetchContent)

set( BOOST_IOSTREAMS_ENABLE_ZSTD OFF CACHE INTERNAL ""  )
set( BOOST_IOSTREAMS_ENABLE_ZLIB OFF CACHE INTERNAL ""  )
set( BOOST_IOSTREAMS_ENABLE_LZMA OFF CACHE INTERNAL ""  )
set( BOOST_IOSTREAMS_ENABLE_BZIP2 OFF CACHE INTERNAL ""  )
set(BUILD_SHARED_LIBS OFF CACHE INTERNAL "Build SHARED libraries")


FetchContent_Declare(
  boost
  #URL /Users/wcjohns/install/wt_fetch_contents/boost-5df8086b733798c8e08e316626a16babe11bd0d2.zip
  GIT_REPOSITORY https://github.com/boostorg/boost.git
  GIT_TAG        5df8086b733798c8e08e316626a16babe11bd0d2 # release-1.79 - beta 1
  GIT_SHALLOW    ON
)

#FetchContent_GetProperties(boost)
#if(NOT boost_POPULATED)
#  FetchContent_Populate(boost)
#  add_subdirectory(${boost_SOURCE_DIR} ${boost_BINARY_DIR} EXCLUDE_FROM_ALL)
#endif()

message("CMAKE_CURRENT_SOURCE_DIR=${CMAKE_CURRENT_SOURCE_DIR}")

FetchContent_Declare(
  wt
  #URL /Users/wcjohns/install/wt_fetch_contents/wt-b84925215d2b45879cf20c0cb340c4e7960d0c53.zip
  GIT_REPOSITORY https://github.com/emweb/wt.git
  GIT_TAG        b84925215d2b45879cf20c0cb340c4e7960d0c53 # 3.7.1
  GIT_SHALLOW    ON

  #The '|| true' is in next command is due to bug in cmake I think: https://gitlab.kitware.com/cmake/cmake/-/issues/21146
  #PATCH_COMMAND ${GIT_EXECUTABLE} apply --ignore-space-change --ignore-whitespace ${CMAKE_CURRENT_SOURCE_DIR}/../patches/wt/3.7.1/FetchContent/wt_3.7.1_FetchContent.git.patch || true
  PATCH_COMMAND patch -p1 < ${CMAKE_CURRENT_SOURCE_DIR}/target/patches/wt/3.7.1/FetchContent/wt_3.7.1_FetchContent.git.patch || true
)

#FetchContent_GetProperties(wt)
#if(NOT wt_POPULATED)
#  FetchContent_Populate(wt)
#  add_subdirectory(${wt_SOURCE_DIR} ${wt_BINARY_DIR} EXCLUDE_FROM_ALL)
#endif()

FetchContent_MakeAvailable( wt boost )


# macOS, iOS, and Android all have zlib already - we dont need to build it
if( NOT APPLE AND NOT ANDROID )
  set(BUILD_SHARED_LIBS OFF CACHE INTERNAL "Build SHARED libraries")

  FetchContent_Declare(
    zlib
    GIT_REPOSITORY https://github.com/madler/zlib.git
    GIT_TAG        21767c654d31d2dccdde4330529775c6c5fd5389 # 1.2.12
    GIT_SHALLOW    ON

    #The '|| true' is in next command is due to bug in cmake I think: https://gitlab.kitware.com/cmake/cmake/-/issues/21146
    #PATCH_COMMAND ${GIT_EXECUTABLE} apply --ignore-space-change --ignore-whitespace ${CMAKE_CURRENT_SOURCE_DIR}/../patches/zlib/1.2.12/FetchContent/zlib_1.2.12.git.patch || true
    PATCH_COMMAND patch -p1 < ${CMAKE_CURRENT_SOURCE_DIR}/target/patches/zlib/1.2.12/FetchContent/zlib_1.2.12.git.patch || true
  )


  FetchContent_MakeAvailable( zlib )

  # This next line fails when building on Fedora Linux; if you comment it out, InterSpec will use system zlib, but
  #  we should add a proper fix for this, or maybe only build zlib if the system doesnt already have it.
  add_library( ZLIB::ZLIB ALIAS ZLIB::zlib )
endif( NOT APPLE AND NOT ANDROID )